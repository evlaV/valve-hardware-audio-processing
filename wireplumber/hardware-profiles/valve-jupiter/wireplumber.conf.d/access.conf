access.rules = [
  ##################################################################
  ## hide virtual and filter-chain misc from flatpak "manager" class
  ## applications
  {
    matches = [
      {
        access = "flatpak"
        media.category = "Manager"
      }
    ]
    actions = {
      update-props = {
        access = "flatpak-manager"
        default_permissions = "all",
      }
      update-perms = [
        {
          matches = [
            { node.name = "output.virtual-sink"    }
            { node.name = "input.virtual-sink"     }
            { node.name = "output.virtual-source"  }
            { node.name = "input.virtual-source"   }
            { node.name = "filter-chain-capture"   }
            { node.name = "filter-chain-source"    }
            { node.name = "filter-chain-sink"      }
            { node.name = "filter-chain-playback"  }
          ]
          actions = {
            permissions = "rwml"
          }
        }
      ]
    }
  }
  ##################################################################
  ## hide virtual and filter-chain misc from flatpak itself
  {
    matches = [
      {
        access = "flatpak"
      }
    ]
    actions = {
      update-props = {
        default_permissions = "rx"
      }
      update-perms = [
        {
          matches = [
            { node.name = "output.virtual-sink"    }
            { node.name = "input.virtual-sink"     }
            { node.name = "output.virtual-source"  }
            { node.name = "input.virtual-source"   }
            { node.name = "filter-chain-capture"   }
            { node.name = "filter-chain-source"    }
            { node.name = "filter-chain-sink"      }
            { node.name = "filter-chain-playback"  }
          ]
          actions = {
            permissions = "r"
          }
        }
      ]
    }
  }
  ##################################################################
  ## hide virtual and filter-chain misc from normal flatpak processes
  {
    matches = [
      {
        access = "restricted"
      }
    ]
    actions = {
      update-props = {
        default_permissions = "rx"
      }
      update-perms = [
        {
          matches = [
            { node.name = "output.virtual-sink"    }
            { node.name = "input.virtual-sink"     }
            { node.name = "output.virtual-source"  }
            { node.name = "input.virtual-source"   }
            { node.name = "filter-chain-capture"   }
            { node.name = "filter-chain-source"    }
            { node.name = "filter-chain-sink"      }
            { node.name = "filter-chain-playback"  }
          ]
          actions = {
            permissions = "r"
          }
        }
      ]
    }
  }
  ##################################################################
  ## hide virtual and filter-chain misc from processes with default
  ## access levels
  {
    matches = [
      {
        access = "default"
      }
    ]
    actions = {
      update-props = {
        default_permissions = "all"
      }
      update-perms = [
        {
          matches = [
            { node.name = "output.virtual-sink"    }
            { node.name = "input.virtual-sink"     }
            { node.name = "output.virtual-source"  }
            { node.name = "input.virtual-source"   }
            { node.name = "filter-chain-capture"   }
            { node.name = "filter-chain-source"    }
            { node.name = "filter-chain-sink"      }
            { node.name = "filter-chain-playback"  }
          ]
          actions = {
            permissions = "rwml"
          }
        }
      ]
    }
  }
  ##################################################################
  ## hide virtual and filter-chain misc from processes which have
  ## unrestricted access but are _not_ pipewire or wireplumber
  {
    matches = [
      ## Match all clients that aren't part of pipewire & wireplumber
      {
        application.name = "!\"pipewire\""
        application.name = "!\"WirePlumber\""
        application.name = "!\"WirePlumber [export]\""
        access = "unrestricted"
      }
    ]
    actions = {
      update-props = {
        ## Give all permissions by default
        default_permissions = "all"
      }
      update-perms = [
        {
          matches = [
            { node.name = "output.virtual-sink"    }
            { node.name = "input.virtual-sink"     }
            { node.name = "output.virtual-source"  }
            { node.name = "input.virtual-source"   }
            { node.name = "filter-chain-capture"   }
            { node.name = "filter-chain-source"    }
            { node.name = "filter-chain-sink"      }
            { node.name = "filter-chain-playback"  }
          ]
          ## This section will remove the exec x permission from
          ## matched nodes (so that they are, in effect,  hidden
          ## from the matched clients), and only give: read, write,
          ## metadata, and link (rwml) permissions to those nodes.
          actions = {
            permissions = "rwml"
          }
        }
      ]
    }
  }
]
